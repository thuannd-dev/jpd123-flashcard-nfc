<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>JPD123 Flashcard Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Roboto", "sans-serif"],
              jp: ["Noto Sans JP", "sans-serif"],
            },
            colors: {
              brand: { dark: "#0f172a", card: "#1e293b", accent: "#8b5cf6" },
            },
          },
        },
      };
    </script>

    <style>
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .perspective-1000 {
        perspective: 1000px;
      }
      .transform-style-3d {
        transform-style: preserve-3d;
      }
      .backface-hidden {
        backface-visibility: hidden;
      }
      .rotate-y-180 {
        transform: rotateY(180deg);
      }
      .card-inner {
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-flip .card-inner {
        transform: rotateY(180deg);
      }
      /* Ruby tag - container cho ch·ªØ Kanji v√† ch√∫ th√≠ch furigana */
      ruby {
        display: inline-flex;
        flex-direction: column-reverse;
        align-items: flex-start; /* CƒÉn tr√°i ƒë·ªÉ furigana hi·ªÉn th·ªã b√™n tr√°i ch·ªØ Kanji */
        vertical-align: bottom;
      }
      /* Ruby text (furigana) - ch√∫ th√≠ch phi√™n √¢m ti·∫øng Nh·∫≠t */
      rt {
        font-size: 0.6em;
        line-height: 1;
        margin-bottom: 2px;
        padding-left: 4px; /* Th√™m kho·∫£ng tr·∫Øng b√™n tr√°i cho furigana */
        text-align: left; /* CƒÉn tr√°i ch√∫ th√≠ch furigana */
        user-select: none;
        display: block; /* ƒê·ªÉ padding ho·∫°t ƒë·ªông */
        width: 100%; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông ƒë·ªÉ padding c√≥ hi·ªáu l·ª±c */
        white-space: pre; /* Gi·ªØ l·∫°i kho·∫£ng tr·∫Øng trong text */
      }
      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .card-image {
        width: 100%;
        max-width: 100%;
        object-fit: cover;
        border-radius: 16px;
        pointer-events: none;
        margin: 0 auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      .card-image-front {
        height: 180px;
      }
      .card-image-back {
        width: 100%;
        max-width: 90%;
        height: 200px;
        border-radius: 12px;
      }
      .kanji-glow {
        text-shadow: 0 0 20px rgba(167, 139, 250, 0.8);
      }
      .prose {
        color: #cbd5e1;
        font-size: 0.9rem;
      }
      .prose strong {
        color: #a78bfa;
        font-weight: 700;
      }
      .prose p {
        margin-bottom: 0.5em;
      }
      /* Preserve whitespace in furigana display */
      #fc-furigana-front {
        white-space: pre; /* Gi·ªØ l·∫°i kho·∫£ng tr·∫Øng trong furigana */
      }
      /* Fix modal scrolling on mobile */
      #modal-word .bg-slate-900 {
        max-height: 85vh;
      }

      /* Quiz animations */
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }
      .shake {
        animation: shake 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: scale(1);
        }
        to {
          opacity: 0;
          transform: scale(0.95);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }
      .fade-out {
        animation: fadeOut 0.3s ease-out;
      }
      .quiz-option:disabled {
        cursor: not-allowed;
        opacity: 0.7;
      }
    </style>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  </head>

  <body
    class="bg-slate-900 text-white font-sans min-h-screen overflow-x-hidden bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 selection:bg-purple-500 selection:text-white"
  >
    <div
      id="global-error"
      class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] text-center text-sm font-bold"
    ></div>

    <div
      id="app"
      class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-black/20 flex flex-col"
    >
      <div
        id="toast"
        class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2 text-sm border border-white/10"
      >
        <i class="fas fa-info-circle text-brand-accent"></i
        ><span id="toast-msg">Th√¥ng b√°o</span>
      </div>

      <section
        id="screen-login"
        class="p-6 flex flex-col justify-center min-h-screen hidden"
      >
        <div class="text-center mb-8">
          <div
            class="w-20 h-20 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-purple-500/30"
          >
            <span class="text-4xl font-bold text-white">JP</span>
          </div>
          <h1 class="text-3xl font-bold mb-2">JPD123 Pro</h1>
          <p class="text-slate-400 text-sm">H·ªçc ti·∫øng Nh·∫≠t (AI + Excel)</p>
        </div>
        <form id="login-form" class="space-y-4">
          <div>
            <label class="text-xs text-slate-400 uppercase">H·ªç v√† t√™n</label
            ><input
              type="text"
              id="login-name"
              class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none"
              required
            />
          </div>
          <div>
            <label class="text-xs text-slate-400 uppercase">Email FPT</label
            ><input
              type="email"
              id="login-email"
              class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none"
              required
            />
          </div>
          <div id="class-input-group" class="hidden">
            <label class="text-xs text-slate-400 uppercase">M√£ l·ªõp</label
            ><input
              type="text"
              id="login-class"
              class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none"
            />
          </div>
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 rounded-xl mt-6 flex justify-center items-center gap-2"
          >
            <span>ƒêƒÉng Nh·∫≠p</span>
            <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
          </button>
        </form>
      </section>

      <section id="screen-dashboard" class="hidden min-h-screen pb-20">
        <header class="p-6 pb-2 flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold">
              Xin ch√†o,
              <span id="user-display-name" class="text-purple-400"></span>
            </h2>
            <p class="text-xs text-slate-400" id="user-role-display">
              H·ªçc sinh
            </p>
          </div>
          <button
            onclick="app.handleLogout()"
            class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-slate-700 border border-slate-700"
          >
            <i class="fas fa-sign-out-alt text-slate-400"></i>
          </button>
        </header>

        <div class="px-6 pb-2">
          <div
            class="flex items-center gap-2 text-xs text-green-400"
            id="connection-status"
          >
            <span class="relative flex h-2 w-2">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-2 w-2 bg-green-500"
              ></span>
            </span>
            ƒê√£ k·∫øt n·ªëi
          </div>
        </div>

        <div class="p-6">
          <div id="lesson-selection-section">
            <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">
              Ch·ªçn b√†i h·ªçc
            </h3>
            <div class="grid grid-cols-2 gap-4" id="lesson-grid"></div>
          </div>

          <div id="teacher-dashboard-controls" class="hidden mt-8 space-y-3">
            <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">
              Qu·∫£n l√Ω
            </h3>

            <button
              onclick="window.app.openAllVocabulary()"
              class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 rounded-xl flex justify-center items-center gap-2 hover:from-purple-700 hover:to-indigo-700 active:scale-95 transition-all mb-3"
            >
              <i class="fas fa-book"></i>
              <span>Qu·∫£n l√Ω t·ª´ v·ª±ng</span>
            </button>

            <button
              onclick="window.app.openClassManagement()"
              class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold py-4 rounded-xl flex justify-center items-center gap-2 hover:from-emerald-700 hover:to-teal-700 active:scale-95 transition-all mb-3"
            >
              <i class="fas fa-users"></i>
              <span>Qu·∫£n l√Ω l·ªõp h·ªçc</span>
            </button>

            <div class="grid grid-cols-2 gap-3">
              <button
                onclick="excelMgr.exportTopWords()"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center hover:bg-slate-700 transition-colors"
              >
                <i class="fas fa-file-excel text-green-400 mb-1 text-lg"></i>
                <span class="text-xs font-bold text-center"
                  >Th·ªëng K√™<br />(Excel)</span
                >
              </button>

              <button
                onclick="document.getElementById('inp-import-excel').click()"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center hover:bg-slate-700 transition-colors"
              >
                <i class="fas fa-file-upload text-yellow-400 mb-1 text-lg"></i>
                <span class="text-xs font-bold text-center"
                  >Nh·∫≠p T·ª´ V·ª±ng<br />(T·∫°o b√†i h·ªçc)</span
                >
              </button>
              <input
                type="file"
                id="inp-import-excel"
                accept=".xlsx, .xls"
                class="hidden"
                onchange="excelMgr.importExcel(this)"
              />
            </div>
          </div>

          <div id="student-dashboard-summary" class="hidden mt-8">
            <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">
              Ti·∫øn ƒë·ªô
            </h3>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-8">
              <i class="fas fa-book-open text-6xl text-slate-600 mb-4"></i>
              <p class="text-slate-400 text-lg">Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o</p>
              <p class="text-slate-500 text-sm mt-2">
                Li√™n h·ªá gi√°o vi√™n ƒë·ªÉ th√™m t·ª´ v·ª±ng
              </p>
            </div>

            <!-- Stats Card -->
            <div id="stats-card" class="glass p-4 rounded-xl">
              <div class="flex justify-between text-sm mb-2">
                <span class="text-slate-300">ƒê√£ thu·ªôc</span>
                <span class="text-green-400 font-bold" id="dash-mastered-count"
                  >0</span
                >
              </div>
              <div class="w-full bg-slate-700 rounded-full h-2.5 mb-4">
                <div
                  id="dash-progress-bar"
                  class="bg-gradient-to-r from-green-400 to-emerald-500 h-2.5 rounded-full"
                  style="width: 0%"
                ></div>
              </div>
              <div class="grid grid-cols-3 gap-2 text-center text-xs">
                <div class="bg-slate-800/50 p-2 rounded-lg">
                  <div
                    class="text-blue-400 font-bold text-lg"
                    id="dash-learning"
                  >
                    0
                  </div>
                  <div>ƒêang h·ªçc</div>
                </div>
                <div class="bg-slate-800/50 p-2 rounded-lg">
                  <div
                    class="text-orange-400 font-bold text-lg"
                    id="dash-review"
                  >
                    0
                  </div>
                  <div>C·∫ßn √¥n</div>
                </div>
                <div class="bg-slate-800/50 p-2 rounded-lg">
                  <div class="text-green-400 font-bold text-lg" id="dash-done">
                    0
                  </div>
                  <div>Thu·ªôc</div>
                </div>
              </div>
            </div>

            <!-- Continue Button -->
            <button
              id="continue-study-btn"
              onclick="window.app.continueStudy()"
              class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 rounded-xl mt-4 flex justify-center items-center gap-2 hover:from-purple-700 hover:to-indigo-700 active:scale-95 transition-all"
            >
              <i class="fas fa-play"></i>
              <span>Ti·∫øp t·ª•c h·ªçc</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Question List Screen (for logged-in users) -->
      <section
        id="screen-question-list"
        class="hidden min-h-screen bg-slate-900 pb-20"
      >
        <header
          class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex items-center justify-between"
        >
          <button
            onclick="app.exitStudyMode()"
            class="text-slate-400 hover:text-white"
          >
            <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
          </button>
          <h2 class="font-bold text-lg">Danh s√°ch t·ª´ v·ª±ng</h2>
          <div class="w-16"></div>
        </header>

        <div class="p-4 space-y-4">
          <!-- Filter Tabs -->
          <div class="flex gap-2 overflow-x-auto pb-2">
            <button
              onclick="questionList.filterByStatus('all')"
              id="filter-all"
              class="px-4 py-2 rounded-full bg-purple-600 text-white font-bold text-sm whitespace-nowrap"
            >
              T·∫•t c·∫£ (<span id="count-all">0</span>)
            </button>
            <button
              onclick="questionList.filterByStatus('learning')"
              id="filter-learning"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-400 font-bold text-sm whitespace-nowrap border border-slate-700"
            >
              ƒêang h·ªçc (<span id="count-learning">0</span>)
            </button>
            <button
              onclick="questionList.filterByStatus('review')"
              id="filter-review"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-400 font-bold text-sm whitespace-nowrap border border-slate-700"
            >
              √în l·∫°i (<span id="count-review">0</span>)
            </button>
            <button
              onclick="questionList.filterByStatus('mastered')"
              id="filter-mastered"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-400 font-bold text-sm whitespace-nowrap border border-slate-700"
            >
              ƒê√£ thu·ªôc (<span id="count-mastered">0</span>)
            </button>
          </div>

          <!-- Search Bar -->
          <div class="relative">
            <i
              class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"
            ></i>
            <input
              type="text"
              id="question-search"
              placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng..."
              class="w-full pl-10 pr-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:border-purple-500 focus:ring-1 focus:ring-purple-500"
              oninput="questionList.search(this.value)"
            />
          </div>

          <!-- Word List -->
          <div id="question-list-container" class="space-y-2">
            <!-- Dynamic content -->
          </div>
        </div>
      </section>

      <section
        id="screen-teacher-manager"
        class="hidden min-h-screen bg-slate-900"
      >
        <header
          class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex items-center justify-between"
        >
          <button
            onclick="app.navigateTo('dashboard')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
          </button>
          <h2 class="font-bold text-lg">T·∫•t c·∫£ t·ª´ v·ª±ng</h2>
          <div class="flex gap-2">
            <button
              onclick="teacherMgr.deleteAllWords()"
              class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-red-500"
              title="X√≥a h·∫øt"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
            <button
              onclick="teacherMgr.showAddModal()"
              class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-purple-500"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </header>
        <div class="p-4">
          <div id="teacher-word-list" class="space-y-3"></div>
        </div>
      </section>

      <section
        id="screen-student-study"
        class="hidden h-screen flex flex-col bg-slate-900"
      >
        <header
          class="p-4 flex justify-between items-center bg-slate-900 z-10 shrink-0"
        >
          <button
            onclick="app.exitStudyMode()"
            class="w-8 h-8 flex items-center justify-center text-slate-400"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
          <div class="font-mono text-sm text-slate-400">
            <span id="fc-current-index">1</span> / <span id="fc-total">20</span>
          </div>
          <button
            onclick="studentStudy.toggleShuffle()"
            id="btn-shuffle"
            class="text-slate-400 hover:text-purple-400 transition-colors"
          >
            <i class="fas fa-random"></i>
          </button>
        </header>
        <div class="w-full bg-slate-800 h-1 shrink-0">
          <div
            id="fc-progress-bar"
            class="bg-purple-500 h-1 transition-all duration-300"
            style="width: 0%"
          ></div>
        </div>
        <div
          class="flex-1 flex flex-col items-center justify-center p-4 relative overflow-hidden"
        >
          <div
            class="perspective-1000 w-full h-full max-h-[550px] cursor-pointer group relative"
            onclick="studentStudy.flipCard()"
          >
            <div
              id="flashcard-inner"
              class="card-inner w-full h-full relative transform-style-3d shadow-2xl shadow-black/50 rounded-3xl"
            >
              <div
                class="absolute w-full h-full backface-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-3xl z-20 overflow-hidden flex flex-col justify-between"
              >
                <div class="flex justify-between p-4 shrink-0 relative z-30">
                  <div
                    onclick="
                      event.stopPropagation();
                      studentStudy.playAudio();
                    "
                    class="p-2 bg-black/20 hover:bg-white/10 rounded-full transition-colors"
                  >
                    <i class="fas fa-volume-up text-slate-300 text-xl"></i>
                  </div>
                  <div
                    onclick="
                      event.stopPropagation();
                      studentStudy.toggleFav();
                    "
                    class="p-2 bg-black/20 hover:bg-white/10 rounded-full transition-colors"
                  >
                    <i
                      id="fc-star"
                      class="far fa-star text-yellow-500 text-xl transition-transform active:scale-125"
                    ></i>
                  </div>
                </div>
                <div
                  class="flex-1 flex flex-col items-center justify-center w-full px-4 pt-4 relative z-20"
                >
                  <div class="w-full text-center shrink-0">
                    <!-- Furigana + Kanji wrapper - gi·ªëng ruby tag structure -->
                    <div class="inline-flex flex-col items-start">
                      <div
                        id="fc-furigana-front"
                        class="text-2xl md:text-3xl font-jp text-purple-300 mb-1 tracking-wide"
                      ></div>
                      <h1
                        id="fc-kanji-front"
                        class="kanji-glow text-5xl md:text-7xl font-jp font-bold text-white tracking-wide leading-tight break-words relative z-50 drop-shadow-lg"
                      ></h1>
                    </div>
                  </div>
                </div>
                <div
                  class="h-10 w-full flex items-center justify-center text-xs text-purple-300 uppercase tracking-widest font-bold animate-pulse shrink-0 bg-black/10 z-30"
                >
                  <span
                    ><i class="fas fa-hand-pointer mr-1"></i> Ch·∫°m ƒë·ªÉ l·∫≠t</span
                  >
                </div>
              </div>
              <div
                class="absolute w-full h-full backface-hidden rotate-y-180 bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-3xl p-4 flex flex-col z-10 overflow-hidden"
              >
                <div
                  class="text-center mb-2 pb-2 border-b border-slate-700/50 mt-2 overflow-y-auto shrink-0"
                  style="max-height: 45%"
                >
                  <div
                    id="fc-image-container-back"
                    class="hidden w-full flex justify-center items-center mb-2"
                  >
                    <img
                      id="fc-image-back"
                      src=""
                      alt="Minh h·ªça"
                      class="card-image card-image-back"
                    />
                  </div>
                  <div
                    id="fc-kanji-back"
                    class="text-3xl font-jp font-bold mb-1 text-white"
                  ></div>
                  <h2
                    id="fc-meaning-vi"
                    class="text-lg font-bold text-purple-300 mb-0 mt-1"
                  ></h2>
                  <p
                    id="fc-romaji"
                    class="text-xs text-slate-500 font-mono"
                  ></p>
                </div>
                <div
                  class="flex-1 space-y-2 overflow-y-auto pr-1 pb-4 scrollbar-hide"
                  id="fc-examples"
                ></div>
              </div>
            </div>
          </div>
          <div
            id="study-nav-buttons"
            class="w-full mt-6 grid grid-cols-5 gap-2 max-w-sm mx-auto shrink-0"
          >
            <button
              onclick="studentStudy.prevCard()"
              class="bg-slate-800 h-12 rounded-full text-slate-400 hover:bg-slate-700"
            >
              <i class="fas fa-undo"></i>
            </button>
            <button
              onclick="studentStudy.markStatus('review')"
              class="col-span-2 bg-slate-800 h-12 rounded-full text-orange-400 font-bold border border-orange-500/30 hover:bg-orange-500/10 text-xs sm:text-sm"
            >
              <i class="fas fa-sync-alt mr-1"></i>√în l·∫°i
            </button>
            <button
              onclick="studentStudy.markStatus('mastered')"
              class="bg-green-600 h-12 rounded-full text-white shadow-lg hover:bg-green-500"
            >
              <i class="fas fa-check"></i>
            </button>
            <button
              id="quiz-nav-button"
              onclick="studentStudy.startQuiz()"
              class="bg-purple-600 h-12 rounded-full text-white hover:bg-purple-700 font-bold text-sm"
            >
              <i class="fas fa-pencil-alt"></i> Quiz
            </button>
          </div>
          <!-- Buttons for NFC mode -->
          <div
            id="quiz-button-nfc"
            class="hidden w-full mt-6 max-w-sm mx-auto shrink-0 space-y-2"
          >
            <!-- Back to List button (logged-in only) -->
            <button
              id="nfc-back-to-list"
              onclick="studentStudy.navigateToQuestionList()"
              class="hidden w-full bg-slate-800 h-12 rounded-full text-slate-300 hover:bg-slate-700 font-bold text-sm border border-slate-700"
            >
              <i class="fas fa-list mr-2"></i>Danh s√°ch t·ª´ v·ª±ng
            </button>

            <!-- Review from current + Quiz buttons -->
            <div class="grid grid-cols-2 gap-2">
              <button
                onclick="studentStudy.startReviewFromCurrent()"
                class="bg-slate-800 h-12 rounded-full text-orange-400 font-bold border border-orange-500/30 hover:bg-orange-500/10 text-sm"
              >
                <i class="fas fa-sync-alt mr-1"></i>√în t·ª´ ƒë√¢y
              </button>
              <button
                onclick="studentStudy.startQuiz()"
                class="bg-purple-600 h-12 rounded-full text-white hover:bg-purple-700 font-bold text-sm"
              >
                <i class="fas fa-pencil-alt mr-1"></i>Quiz
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Quiz Section -->
      <section
        id="screen-quiz"
        class="hidden min-h-screen bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950 flex items-center justify-center p-4"
      >
        <div class="w-full max-w-2xl">
          <!-- Quiz Header -->
          <div class="text-center mb-8">
            <div
              class="inline-block bg-purple-900/30 px-6 py-2 rounded-full border border-purple-500/30 mb-4"
            >
              <span class="text-purple-300 text-sm font-bold"
                >B√†i t·∫≠p tr·∫Øc nghi·ªám</span
              >
              <span
                id="quiz-progress"
                class="text-purple-400 text-xs ml-2"
              ></span>
            </div>
            <div
              class="bg-slate-900/50 backdrop-blur p-6 rounded-2xl border border-slate-700 mb-6"
            >
              <div
                id="quiz-furigana"
                class="text-xl md:text-2xl font-jp text-purple-300 mb-2"
              ></div>
              <h2
                id="quiz-question"
                class="text-4xl md:text-5xl font-jp font-bold text-white"
              ></h2>
            </div>
            <p class="text-slate-400 text-sm">Ch·ªçn nghƒ©a ti·∫øng Vi·ªát ƒë√∫ng</p>
          </div>

          <!-- Answer Options -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button
              id="quiz-option-0"
              onclick="studentStudy.checkAnswer(0)"
              class="quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center"
            >
              <span class="font-bold text-2xl text-purple-400 mr-4">A.</span>
              <span id="quiz-text-0" class="text-lg"></span>
            </button>
            <button
              id="quiz-option-1"
              onclick="studentStudy.checkAnswer(1)"
              class="quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center"
            >
              <span class="font-bold text-2xl text-purple-400 mr-4">B.</span>
              <span id="quiz-text-1" class="text-lg"></span>
            </button>
            <button
              id="quiz-option-2"
              onclick="studentStudy.checkAnswer(2)"
              class="quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center"
            >
              <span class="font-bold text-2xl text-purple-400 mr-4">C.</span>
              <span id="quiz-text-2" class="text-lg"></span>
            </button>
            <button
              id="quiz-option-3"
              onclick="studentStudy.checkAnswer(3)"
              class="quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center"
            >
              <span class="font-bold text-2xl text-purple-400 mr-4">D.</span>
              <span id="quiz-text-3" class="text-lg"></span>
            </button>
          </div>

          <!-- Continue Button -->
          <div class="text-center">
            <button
              id="quiz-continue-btn"
              onclick="studentStudy.exitQuiz()"
              class="hidden bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all duration-300"
            >
              Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </section>

      <!-- Class Management Screen -->
      <section
        id="screen-class-management"
        class="hidden min-h-screen bg-slate-900"
      >
        <header
          class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex items-center justify-between"
        >
          <button
            onclick="app.navigateTo('dashboard')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
          </button>
          <h2 class="font-bold text-lg">Qu·∫£n l√Ω l·ªõp h·ªçc</h2>
          <div class="w-8"></div>
        </header>

        <div class="p-4 space-y-4">
          <!-- Summary Stats -->
          <div class="grid grid-cols-3 gap-3">
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
              <div class="text-blue-400 text-2xl font-bold" id="total-students">
                0
              </div>
              <div class="text-slate-400 text-xs">H·ªçc sinh</div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
              <div
                class="text-green-400 text-2xl font-bold"
                id="total-words-count"
              >
                0
              </div>
              <div class="text-slate-400 text-xs">T·ª´ v·ª±ng</div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
              <div class="text-purple-400 text-2xl font-bold" id="avg-mastery">
                0%
              </div>
              <div class="text-slate-400 text-xs">TB ƒê√£ thu·ªôc</div>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="flex gap-2 border-b border-slate-800">
            <button
              onclick="window.classMgr.switchTab('students')"
              id="tab-students"
              class="px-4 py-2 font-bold border-b-2 border-purple-500 text-purple-400"
            >
              Theo h·ªçc sinh
            </button>
            <button
              onclick="window.classMgr.switchTab('words')"
              id="tab-words"
              class="px-4 py-2 font-bold border-b-2 border-transparent text-slate-400 hover:text-white"
            >
              Theo t·ª´ v·ª±ng
            </button>
          </div>

          <!-- Students View -->
          <div id="view-students" class="space-y-3">
            <!-- Dynamic content -->
          </div>

          <!-- Words View -->
          <div id="view-words" class="hidden space-y-3">
            <!-- Dynamic content -->
          </div>

          <!-- Word Detail Modal -->
          <div
            id="modal-word-detail"
            class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4"
          >
            <div
              class="bg-slate-900 w-full max-w-2xl rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[80vh]"
            >
              <div
                class="p-4 border-b border-slate-800 flex justify-between items-center bg-gradient-to-r from-purple-900/50 to-pink-900/50 rounded-t-2xl"
              >
                <div>
                  <p
                    class="text-sm text-purple-300"
                    id="word-detail-furigana"
                  ></p>
                  <h3
                    class="font-bold text-2xl text-white font-jp"
                    id="word-detail-kanji"
                  ></h3>
                  <p class="text-xs text-slate-400" id="word-detail-vi"></p>
                </div>
                <button
                  onclick="window.classMgr.closeWordDetail()"
                  class="text-slate-400 hover:text-white"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-6 overflow-y-auto flex-1" id="word-detail-content">
                <!-- Dynamic content -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <div
        id="modal-ai"
        class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4"
      >
        <div
          class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[80vh]"
        >
          <div
            class="p-4 border-b border-slate-800 flex justify-between items-center bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-t-2xl"
          >
            <h3 class="font-bold text-lg text-white">
              <i class="fas fa-robot text-purple-400 mr-2"></i>AI Tr·ª£ l√Ω
            </h3>
            <button
              onclick="geminiService.closeModal()"
              class="text-slate-400 hover:text-white"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div
            class="p-6 overflow-y-auto flex-1 leading-relaxed space-y-2"
            id="ai-content"
          ></div>
          <div class="p-4 border-t border-slate-800 text-center">
            <button
              onclick="geminiService.closeModal()"
              class="bg-slate-800 text-white px-6 py-2 rounded-xl hover:bg-slate-700 w-full"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>

      <div
        id="modal-word"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"
      >
        <div
          class="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 max-h-[90vh] flex flex-col"
        >
          <div
            class="p-4 border-b border-slate-800 flex justify-between items-center"
          >
            <h3 class="font-bold text-lg">Th√¥ng tin t·ª´ v·ª±ng</h3>
            <button
              onclick="teacherMgr.closeModal()"
              class="text-slate-400 hover:text-white"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="p-4 overflow-y-auto space-y-4 flex-1">
            <input type="hidden" id="word-mode" />
            <div>
              <label class="text-xs text-slate-500 block mb-1"
                >ID (T·ª± t·∫°o)</label
              ><input
                type="text"
                id="inp-id"
                class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm font-mono text-yellow-400"
              />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-slate-500 block mb-1">Kanji</label
                ><input
                  type="text"
                  id="inp-kanji"
                  class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                />
              </div>
              <div>
                <label class="text-xs text-slate-500 block mb-1">Hiragana</label
                ><input
                  type="text"
                  id="inp-furigana"
                  class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                />
              </div>
              <div>
                <label class="text-xs text-slate-500 block mb-1">Romaji</label
                ><input
                  type="text"
                  id="inp-romaji"
                  class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                />
              </div>
              <div>
                <label class="text-xs text-slate-500 block mb-1"
                  >Nghƒ©a Vi·ªát</label
                ><input
                  type="text"
                  id="inp-vi"
                  class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                />
              </div>
            </div>

            <div class="border border-slate-700 p-3 rounded bg-slate-800/50">
              <label
                class="text-xs text-slate-400 block mb-2 font-bold uppercase"
                >H√¨nh ·∫£nh minh h·ªça</label
              >
              <input
                type="file"
                id="inp-image-file"
                accept="image/*"
                class="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer"
              />
              <div id="preview-image-container" class="mt-2 hidden">
                <img
                  id="preview-image"
                  src=""
                  class="h-20 rounded object-contain border border-slate-600"
                />
              </div>
              <input type="hidden" id="inp-image-base64" />
            </div>

            <div class="border-t border-slate-800 pt-3">
              <div class="flex justify-between items-center mb-2">
                <label class="text-xs text-slate-500 font-bold"
                  >2 C√¢u V√≠ d·ª•</label
                >
                <button
                  type="button"
                  onclick="geminiService.generateExamples()"
                  class="bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-1 rounded shadow flex items-center gap-1 font-bold"
                >
                  <i class="fas fa-pencil-alt"></i> AI T·∫°o V√≠ D·ª•
                </button>
              </div>
              <div id="example-inputs-container" class="space-y-2"></div>
            </div>

            <!-- Custom Quiz Section -->
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
              <div class="flex items-center justify-between mb-3">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="custom-quiz-enabled"
                    class="w-5 h-5 rounded bg-slate-700 border-slate-600 text-purple-600 focus:ring-2 focus:ring-purple-500"
                    onchange="
                      document
                        .getElementById('custom-quiz-form')
                        .classList.toggle('hidden')
                    "
                  />
                  <span class="font-bold text-white"
                    >T·∫°o quiz ri√™ng cho t·ª´ n√†y</span
                  >
                </label>
                <span class="text-xs text-slate-400">üìù Quiz t√πy ch·ªânh</span>
              </div>

              <div
                id="custom-quiz-form"
                class="hidden space-y-4 mt-3 max-h-[60vh] overflow-y-auto pr-2"
              >
                <p
                  class="text-xs text-slate-400 italic bg-purple-900/20 p-2 rounded border border-purple-500/30"
                >
                  <i class="fas fa-info-circle"></i> T·∫°o 5 c√¢u h·ªèi - H·ªçc sinh s·∫Ω
                  l√†m tu·∫ßn t·ª± v√† th·∫•y k·∫øt qu·∫£ t·ªïng
                </p>

                <!-- Quiz questions container - will be populated by JS -->
                <div id="quiz-questions-container"></div>

                <button
                  type="button"
                  onclick="teacherMgr.addQuizQuestion()"
                  class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded text-sm font-bold"
                >
                  <i class="fas fa-plus mr-1"></i> Th√™m c√¢u h·ªèi (t·ªëi ƒëa 5)
                </button>
              </div>
            </div>
          </div>
          <div class="p-4 border-t border-slate-800 grid grid-cols-2 gap-4">
            <button
              onclick="teacherMgr.closeModal()"
              class="py-2 text-slate-400 hover:text-white"
            >
              H·ªßy
            </button>
            <button
              onclick="teacherMgr.saveWord()"
              class="py-2 bg-purple-600 rounded-lg text-white font-bold"
            >
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.onerror = function (msg, url, line, col, error) {
        const errDiv = document.getElementById("global-error");
        if (errDiv) {
          errDiv.classList.remove("hidden");
          errDiv.innerHTML = `L·ªói h·ªá th·ªëng: ${msg} <br> (D√≤ng: ${line})`;
        }
        console.error("Global Error:", msg, error);
        return false;
      };

      const firebaseConfig = {
        apiKey: "AIzaSyBtlslkylHhhhQCSL9fwxBK5QQpXwqp8rw",
        authDomain: "jpd123-flashcard.firebaseapp.com",
        databaseURL:
          "https://jpd123-flashcard-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "jpd123-flashcard",
        storageBucket: "jpd123-flashcard.firebasestorage.app",
        messagingSenderId: "1085810162442",
        appId: "1:1085810162442:web:c69c3bd93a219fa2a118f3",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const dbRef = firebase.database().ref();

      // 2. API KEY (ƒê√É S·ª¨A: KEY C·ª¶A B·∫†N - VUI L√íNG T·∫†O L·∫†I TRONG D·ª∞ √ÅN M·ªöI N·∫æU V·∫™N L·ªñI)
      let userApiKey = "";
      const apiKey = "AIzaSyD7ncWsup6M8r9w_7wP-ZqCLl9T8y5Hj8k";

      const TEACHER_DOMAINS = ["@fe.edu.vn", "@fpt.com.vn"];
      const SPECIAL_TEACHERS = [
        "anhbpsa180223@fpt.edu.vn",
        "oanhvttsa170012@fpt.edu.vn",
        "thuthasa180107@fpt.edu.vn",
        "a@fpt.edu.vn",
      ];
      const STUDENT_DOMAIN = "@fpt.edu.vn";
      const LESSONS = [4, 5, 6, 7];

      window.SEED_DATA = [];
      window.db = { words: [], progress: {} };
      window.session = {
        user: null,
        currentLesson: null,
        nfcTarget: null,
        studyList: [],
        currentIndex: 0,
        isShuffle: false,
      };
      window.__progressDocs = [];

      const $ = (id) => document.getElementById(id);
      const showScreen = (id) => {
        document
          .querySelectorAll('section[id^="screen-"]')
          .forEach((el) => el.classList.add("hidden"));
        $(id).classList.remove("hidden");
      };
      const showToast = (msg) => {
        const t = $("toast");
        $("toast-msg").innerText = msg;
        t.classList.remove("opacity-0");
        setTimeout(() => t.classList.add("opacity-0"), 2000);
      };

      const stripRuby = (text) => {
        if (!text) return "";
        return text
          .replace(/<rt>.*?<\/rt>/g, "")
          .replace(/<\/?ruby>/g, "")
          .replace(/<\/?[^>]+>/g, "");
      };

      const speakJP = (text) => {
        if (!text) return;
        const clean = stripRuby(text);
        const u = new SpeechSynthesisUtterance(clean);
        u.lang = "ja-JP";
        window.speechSynthesis.speak(u);
      };
      const generateRubyHtml = (k, f) =>
        !f || k === f ? k : `<ruby>${k}<rt>${f}</rt></ruby>`;

      window.logout = () => {
        localStorage.removeItem("jpd123_user");
        // X√≥a URL params ƒë·ªÉ tr√°nh t·ª± ƒë·ªông t·∫°o guest l·∫°i
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname,
        );
        location.reload();
      };

      const compressImage = (file, callback) => {
        // Check if file is a GIF - preserve animation by skipping Canvas compression
        if (file.type === "image/gif") {
          // Check size limit for GIFs (5MB)
          if (file.size > 5 * 1024 * 1024) {
            showToast("File GIF qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.");
            return;
          }
          // Read GIF directly without compression to preserve animation
          const reader = new FileReader();
          reader.onload = (e) => {
            callback(e.target.result);
          };
          reader.readAsDataURL(file);
          return;
        }

        // For other image formats (JPEG, PNG, etc.), use Canvas compression
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const MAX_SIZE = 800;
            let width = img.width,
              height = img.height;
            if (width > height) {
              if (width > MAX_SIZE) {
                height *= MAX_SIZE / width;
                width = MAX_SIZE;
              }
            } else {
              if (height > MAX_SIZE) {
                width *= MAX_SIZE / height;
                height = MAX_SIZE;
              }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL("image/jpeg", 0.7));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      };

      const handleImageUpload = (input) => {
        const file = input.files[0];
        if (!file) return;
        compressImage(file, (base64) => {
          $("inp-image-base64").value = base64;
          $("preview-image").src = base64;
          $("preview-image-container").classList.remove("hidden");
        });
      };

      window.dataMgr = {
        /* ... */
      };

      window.excelMgr = {
        exportTopWords: () => {
          const allStudents = window.__progressDocs || [];
          const allWords = window.db.words || [];
          if (allStudents.length === 0)
            return showToast("Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc sinh!");
          const wordStats = {};
          allStudents.forEach((student) => {
            const progress = student.progress || {};
            Object.keys(progress).forEach((wordId) => {
              if (progress[wordId].status === "mastered") {
                wordStats[wordId] = (wordStats[wordId] || 0) + 1;
              }
            });
          });
          const reportData = allWords.map((w) => {
            return {
              B√†i: w.lesson,
              Kanji: w.kanji,
              Hiragana: w.furigana,
              Nghƒ©a: w.vi,
              "S·ªë HS Thu·ªôc": wordStats[w.id] || 0,
            };
          });
          reportData.sort((a, b) => b["S·ªë HS Thu·ªôc"] - a["S·ªë HS Thu·ªôc"]);
          const worksheet = XLSX.utils.json_to_sheet(reportData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Th·ªëng K√™");
          XLSX.writeFile(workbook, "JPD123_ThongKe.xlsx");
          showToast("ƒê√£ xu·∫•t Excel!");
        },
        importExcel: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);
              if (jsonData.length === 0) return alert("File Excel r·ªóng!");
              if (!jsonData[0].Kanji || !jsonData[0].Lesson)
                return alert("Excel sai m·∫´u (C·∫ßn c·ªôt Lesson, Kanji...)");
              if (!confirm(`Th√™m ${jsonData.length} t·ª´ m·ªõi?`)) {
                input.value = "";
                return;
              }
              showToast("ƒêang x·ª≠ l√Ω...");
              let count = 0;
              for (const row of jsonData) {
                const safeRomaji = (row.Romaji || "word")
                  .toString()
                  .toLowerCase()
                  .replace(/[^a-z0-9]/g, "");
                const id = `${row.Lesson}_${safeRomaji}_${Date.now()}_${count}`;
                const newWord = {
                  id,
                  lesson: parseInt(row.Lesson) || 1,
                  kanji: row.Kanji || "",
                  furigana: row.Furigana || "",
                  romaji: row.Romaji || "",
                  vi: row["Nghƒ©a"] || "",
                  image: "",
                  examples: [],
                };
                if (row["V√≠ d·ª• Nh·∫≠t"] && row["V√≠ d·ª• Vi·ªát"])
                  newWord.examples.push({
                    jp: row["V√≠ d·ª• Nh·∫≠t"],
                    vi: row["V√≠ d·ª• Vi·ªát"],
                  });
                await window.cloud.saveWord(newWord);
                count++;
              }
              alert(`ƒê√£ th√™m ${count} t·ª´!`);
              input.value = "";
            } catch (err) {
              console.error(err);
              alert("L·ªói ƒë·ªçc file Excel!");
              input.value = "";
            }
          };
          reader.readAsArrayBuffer(file);
        },
      };

      // --- GEMINI SERVICE ---
      window.geminiService = {
        getKey: () => {
          if (apiKey) return apiKey.trim();
          if (userApiKey) return userApiKey.trim();
          const i = prompt("Nh·∫≠p API Key Gemini (n·∫øu c√≥):");
          if (i && i.trim()) {
            userApiKey = i.trim();
            return userApiKey;
          }
          return null;
        },

        // H√†m g·ªçi AI th√¥ng minh: Th·ª≠ l·∫ßn l∆∞·ª£t c√°c Model
        callGemini: async (promptText) => {
          const key = window.geminiService.getKey();
          if (!key) throw new Error("Ch∆∞a c√≥ Key");

          const models = [
            "gemini-2.5-flash",
            "gemini-2.5-pro",
            "gemini-flash-latest",
          ];

          for (const model of models) {
            try {
              console.log(`ƒêang th·ª≠ model: ${model}`);
              const res = await fetch(
                `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${key}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                  }),
                },
              );
              const data = await res.json();

              if (res.ok) {
                console.log(`‚úÖ Model ${model} ho·∫°t ƒë·ªông!`);
                return (data.candidates?.[0]?.content?.parts || [])
                  .map((p) => p.text)
                  .join("")
                  .trim();
              }

              // Log chi ti·∫øt l·ªói ƒë·ªÉ debug
              console.error(`‚ùå Model ${model} l·ªói:`, data.error || data);

              if (data.error && data.error.code === 404) {
                console.warn(
                  `Model ${model} kh√¥ng d√πng ƒë∆∞·ª£c (404), ƒëang th·ª≠ c√°i kh√°c...`,
                );
                continue;
              }

              // N·∫øu l√† l·ªói authentication ho·∫∑c permission, throw ngay
              if (
                data.error &&
                (data.error.code === 403 || data.error.code === 401)
              ) {
                throw new Error(
                  `L·ªói API Key: ${data.error.message}. Vui l√≤ng ki·ªÉm tra API key v√† enable 'Generative Language API' trong Google Cloud Console.`,
                );
              }

              throw new Error(data.error?.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
            } catch (e) {
              console.error(`‚ö†Ô∏è L·ªói khi g·ªçi model ${model}:`, e.message);
              if (models.indexOf(model) === models.length - 1) throw e;
            }
          }
          throw new Error(
            "T·∫•t c·∫£ Model ƒë·ªÅu l·ªói! Ki·ªÉm tra Console ƒë·ªÉ xem chi ti·∫øt l·ªói.",
          );
        },

        // T·ª± ƒë·ªông t·∫°o v√≠ d·ª•
        generateExamples: async () => {
          const k = $("inp-kanji").value || "";
          const m = $("inp-vi").value || "";
          if (!k.trim()) return alert("Vui l√≤ng nh·∫≠p Kanji tr∆∞·ªõc!");

          showToast("ƒêang t·∫°o v√≠ d·ª•...");
          try {
            const promptText = `Generate 2 simple Japanese example sentences for "${k}" (Meaning: ${m}). Return JSON array: [{"jp":"sentence with ruby","vi":"meaning"}]. RULES: Wrap Kanji with <ruby>Kanji<rt>kana</rt></ruby>.`;
            let raw = await window.geminiService.callGemini(promptText);

            const jsonMatch = raw.match(/\[[\s\S]*\]/);
            const jsonStr = jsonMatch ? jsonMatch[0] : raw;
            const json = JSON.parse(jsonStr);

            window.teacherMgr.renderExampleInputs(json);
          } catch (e) {
            alert("L·ªói t·∫°o v√≠ d·ª•: " + e.message);
          }
        },

        // AI Th√™m Furigana + D·ªãch
        enrichExample: async (index) => {
          const jpInput = $(`inp-ex-jp-${index}`);
          const viInput = $(`inp-ex-vi-${index}`);
          const btn = $(`btn-ai-ex-${index}`);
          if (!jpInput || !viInput) return;
          const sentence = jpInput.value.trim();
          if (!sentence) return alert("Vui l√≤ng nh·∫≠p c√¢u Nh·∫≠t tr∆∞·ªõc.");

          if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ...`;
          }

          try {
            const promptText = `You are a Japanese teacher. I will give you ONE sentence. 
                    1. Add furigana to all Kanji using ruby tags (<ruby>Kanji<rt>hiragana</rt></ruby>). 
                    2. Translate to Vietnamese.
                    Return JSON: {"jp":"...", "vi":"..."}. Sentence: ${sentence}`;

            let rawText = await window.geminiService.callGemini(promptText);

            const jsonMatch = rawText.match(/\{[\s\S]*\}/);
            const jsonStr = jsonMatch ? jsonMatch[0] : rawText;
            const obj = JSON.parse(jsonStr);

            if (obj.jp) jpInput.value = obj.jp;
            if (obj.vi) viInput.value = obj.vi;
          } catch (e) {
            alert("L·ªói AI: " + e.message);
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = `<i class="fas fa-wand-magic-sparkles"></i> AI Furigana + D·ªãch`;
            }
          }
        },
        closeModal: () => $("modal-ai").classList.add("hidden"),
      };

      window.loadData = () => {
        $("connection-status").innerHTML =
          '<span class="animate-pulse text-green-400">‚óè</span> Online Mode';
        dbRef.child("words").on("value", (snapshot) => {
          const data = snapshot.val();
          window.db.words = data ? Object.values(data) : [];
          if (window.handleVocabUpdate) window.handleVocabUpdate();
        });
        dbRef.child("progress_all").on("value", (snapshot) => {
          const data = snapshot.val();
          window.__progressDocs = data ? Object.values(data) : [];
        });
        const u = localStorage.getItem("jpd123_user");
        if (u) {
          const user = JSON.parse(u);
          const safeEmail = user.email.replace(/\./g, ",");
          dbRef
            .child("progress_detail/" + safeEmail)
            .on("value", (snapshot) => {
              window.db.progress = { [user.email]: snapshot.val() || {} };
              if (window.session.user?.role === "student")
                app.renderStudentDashboardStats();
            });
        }
      };

      window.cloud = {
        saveWord: async (word) => {
          try {
            await dbRef.child("words/" + word.id).set(word);
            return true;
          } catch (e) {
            alert("L·ªói l∆∞u: " + e.message);
            return false;
          }
        },
        deleteWord: async (id) => {
          try {
            await dbRef.child("words/" + id).remove();
            return true;
          } catch (e) {
            alert("L·ªói x√≥a: " + e.message);
            return false;
          }
        },
      };

      window.progressCloud = {
        saveStudentProgress: async (student) => {
          const safeEmail = student.email.replace(/\./g, ",");
          await dbRef.child("progress_all/" + safeEmail).set(student);
          await dbRef
            .child("progress_detail/" + safeEmail)
            .set(student.progress);
          return true;
        },
      };

      window.app = {
        init: () => {
          window.loadData();
          const p = new URLSearchParams(location.search);
          if (p.get("id"))
            window.session.nfcTarget = {
              id: p.get("id"),
            };

          const u = localStorage.getItem("jpd123_user");
          if (u) {
            window.session.user = JSON.parse(u);
            window.app.checkRedirect();
          } else if (window.session.nfcTarget) {
            // Auto-create guest user when NFC scan detected
            window.session.user = {
              name: "Guest",
              email: "guest@nfc.temp",
              role: "student",
              className: "",
            };
            window.app.checkRedirect();
          } else {
            showScreen("screen-login");
            $("login-email").oninput = (e) => {
              const val = e.target.value;
              const isTeacher =
                SPECIAL_TEACHERS.includes(val) ||
                TEACHER_DOMAINS.some((d) => val.endsWith(d));
              $("class-input-group").classList.toggle("hidden", isTeacher);
            };
          }

          $("login-form").onsubmit = (e) => {
            e.preventDefault();
            $("login-spinner").classList.remove("hidden");
            setTimeout(() => {
              const eVal = $("login-email").value.toLowerCase();
              const role =
                SPECIAL_TEACHERS.includes(eVal) ||
                TEACHER_DOMAINS.some((d) => eVal.endsWith(d))
                  ? "teacher"
                  : eVal.endsWith(STUDENT_DOMAIN)
                    ? "student"
                    : null;
              if (!role) {
                $("login-spinner").classList.add("hidden");
                return alert("Email kh√¥ng h·ª£p l·ªá!");
              }
              window.session.user = {
                name: $("login-name").value,
                email: eVal,
                role,
                className: $("login-class").value || "",
              };
              localStorage.setItem(
                "jpd123_user",
                JSON.stringify(window.session.user),
              );
              window.app.checkRedirect();
            }, 400);
          };
          $("inp-image-file").addEventListener("change", function () {
            handleImageUpload(this);
          });
        },
        checkRedirect: () => {
          // NFC -> T√¨m t·ª´ ƒë∆∞·ª£c qu√©t trong T·∫§T C·∫¢ t·ª´ v·ª±ng -> Hi·ªÉn th·ªã t·∫•t c·∫£ t·ª´, focus v√†o t·ª´ ƒë∆∞·ª£c qu√©t
          if (window.session.nfcTarget) {
            if (window.db.words.length === 0) {
              setTimeout(window.app.checkRedirect, 500);
              return;
            }

            // T√¨m t·ª´ c·ª• th·ªÉ ƒë∆∞·ª£c qu√©t trong T·∫§T C·∫¢ t·ª´ v·ª±ng
            const targetWord = window.db.words.find(
              (x) => x.id === window.session.nfcTarget.id,
            );

            if (targetWord) {
              window.session.currentLesson = null;
              window.session.isNFCMode = true; // Flag to indicate NFC mode
              // Init v·ªõi CH·ªà M·ªòT t·ª´ ƒë∆∞·ª£c qu√©t
              window.studentStudy.init([targetWord], targetWord.id);
              showScreen("screen-student-study");
              window.session.nfcTarget = null;
              return;
            }
          }

          // Auto-start study mode for students (only on first login, not when returning from study)
          if (
            window.session.user.role === "student" &&
            !window.session.hasVisitedDashboard
          ) {
            if (window.db.words.length === 0) {
              setTimeout(window.app.checkRedirect, 500);
              return;
            }
            window.session.currentLesson = null; // All lessons mode
            window.session.isNFCMode = false; // Reset NFC mode
            // Load last studied position from localStorage
            const savedIndex = localStorage.getItem("jpd123_lastStudiedIndex");
            const startIndex = savedIndex ? parseInt(savedIndex) : 0;
            window.studentStudy.init(window.db.words, null, startIndex);
            showScreen("screen-student-study");
            return;
          }

          window.app.initDashboard();
        },
        initDashboard: () => {
          // Mark that student has visited dashboard (prevents auto-start on return)
          window.session.hasVisitedDashboard = true;

          $("user-display-name").innerText = window.session.user.name;
          $("user-role-display").innerText =
            window.session.user.role === "teacher"
              ? "Gi√°o vi√™n (Online)"
              : `H·ªçc sinh - ${window.session.user.className || "N/A"}`;

          if (window.session.user.role === "teacher") {
            // Teachers don't see lesson selection anymore
            $("lesson-selection-section").classList.add("hidden");
            $("teacher-dashboard-controls").classList.remove("hidden");
            $("student-dashboard-summary").classList.add("hidden");
          } else {
            // Students don't see lesson selection
            $("lesson-selection-section").classList.add("hidden");
            $("teacher-dashboard-controls").classList.add("hidden");
            $("student-dashboard-summary").classList.remove("hidden");
            window.app.renderStudentDashboardStats();
          }
          showScreen("screen-dashboard");
        },
        renderStudentDashboardStats: () => {
          const totalWords = window.db.words.length;

          // Show empty state if no vocabulary
          if (totalWords === 0) {
            $("empty-state").classList.remove("hidden");
            $("stats-card").classList.add("hidden");
            $("continue-study-btn").classList.add("hidden");
            return;
          }

          // Show stats and continue button
          $("empty-state").classList.add("hidden");
          $("stats-card").classList.remove("hidden");
          $("continue-study-btn").classList.remove("hidden");

          let s = { l: 0, r: 0, m: 0 };
          const email = window.session.user.email;
          if (window.db.progress[email]) {
            Object.values(window.db.progress[email]).forEach((i) => {
              if (i.status === "mastered") s.m++;
              else if (i.status === "review") s.r++;
              else s.l++;
            });
          }
          $("dash-learning").innerText = s.l;
          $("dash-review").innerText = s.r;
          $("dash-done").innerText = s.m;
          $("dash-mastered-count").innerText = `${s.m}/${totalWords}`;
          $("dash-progress-bar").style.width = `${(s.m / totalWords) * 100}%`;
        },
        continueStudy: () => {
          if (window.db.words.length === 0) {
            showToast("Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o!");
            return;
          }
          window.session.currentLesson = null;
          window.session.isNFCMode = false; // Reset NFC mode
          const savedIndex = localStorage.getItem("jpd123_lastStudiedIndex");
          const startIndex = savedIndex ? parseInt(savedIndex) : 0;
          window.studentStudy.init(window.db.words, null, startIndex);
          showScreen("screen-student-study");
        },
        openAllVocabulary: () => {
          window.teacherMgr.init(null, window.db.words);
          showScreen("screen-teacher-manager");
        },
        openClassManagement: () => {
          window.classMgr.init();
          showScreen("screen-class-management");
        },
        selectLesson: (n, tid) => {
          window.session.currentLesson = n;
          const w = window.db.words.filter((x) => x.lesson === n);
          if (window.session.user.role === "teacher") {
            window.teacherMgr.init(n, w);
            showScreen("screen-teacher-manager");
          } else {
            if (!w.length) return showToast("B√†i n√†y ch∆∞a c√≥ t·ª´ v·ª±ng!");
            window.studentStudy.init(w, tid);
            showScreen("screen-student-study");
          }
        },
        navigateTo: (s) => {
          if (s === "dashboard") window.app.initDashboard();
          else showScreen("screen-" + s);
        },
        exitStudyMode: () => {
          if (
            window.session.user &&
            window.session.user.email === "guest@nfc.temp"
          ) {
            window.app.navigateTo("dashboard");
          } else {
            // Ng∆∞·ªùi d√πng th∆∞·ªùng th√¨ quay v·ªÅ dashboard
            window.app.navigateTo("dashboard");
          }
        },
        handleLogout: () => {
          // N·∫øu l√† guest, lu√¥n logout v·ªÅ trang login
          // Ng∆∞·ªùi d√πng th∆∞·ªùng c≈©ng logout b√¨nh th∆∞·ªùng
          logout();
        },
      };

      // --- TEACHER MANAGER ---
      window.teacherMgr = {
        currentWords: [],
        init: (l, w) => {
          window.teacherMgr.currentWords = w;
          // No longer need to show lesson number
          window.teacherMgr.renderList();
        },

        renderList: () => {
          const listEl = $("teacher-word-list");
          const baseUrl = location.origin + location.pathname;
          listEl.parentElement.classList.add("pb-40");

          listEl.innerHTML = window.teacherMgr.currentWords
            .map((w) => {
              const link = `${baseUrl}?id=${w.id}`;
              const safeId = String(w.id)
                .replace(/'/g, "\\'")
                .replace(/"/g, "&quot;");

              // Check if word has custom quiz
              const hasCustomQuiz = w.customQuiz?.enabled;

              return `
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-3 flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3 overflow-hidden">
                            ${
                              w.image
                                ? `<img src="${w.image}" class="w-10 h-10 rounded object-cover bg-slate-900 shrink-0">`
                                : '<div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-xs text-slate-500 shrink-0">No img</div>'
                            }
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-lg font-jp truncate text-white">${
                                      w.kanji
                                    }</div>
                                    ${hasCustomQuiz ? '<span class="text-xs bg-purple-600/30 text-purple-300 px-2 py-0.5 rounded-full border border-purple-500/30 shrink-0">üìù Quiz</span>' : ""}
                                </div>
                                <div class="text-xs text-slate-400 truncate">${
                                  w.vi
                                }</div>
                            </div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="window.teacherMgr.copyLink('${link}')" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-link text-sm text-slate-300"></i></button>
                            <button onclick="window.teacherMgr.editWord('${safeId}')" class="w-10 h-10 rounded-full bg-blue-900/40 text-blue-400 flex items-center justify-center hover:bg-blue-900/60 border border-blue-500/30"><i class="fas fa-pen text-sm"></i></button>
                            <button onclick="window.teacherMgr.deleteWord('${safeId}')" class="w-10 h-10 rounded-full bg-red-900/40 text-red-400 flex items-center justify-center hover:bg-red-900/60 border border-red-500/30"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </div>`;
            })
            .join("");
        },

        copyLink: (u) => {
          if (navigator.clipboard)
            navigator.clipboard
              .writeText(u)
              .then(() => showToast("ƒê√£ copy link!"))
              .catch(() => prompt("Copy:", u));
          else prompt("Copy:", u);
        },

        showAddModal: () => {
          $("word-mode").value = "add";
          $("inp-id").value = Date.now(); // T·ª± sinh ID s·ªë
          $("inp-id").disabled = false;
          [
            "inp-kanji",
            "inp-furigana",
            "inp-romaji",
            "inp-vi",
            "inp-image-base64",
          ].forEach((id) => ($(id).value = ""));
          $("inp-image-file").value = "";
          $("preview-image-container").classList.add("hidden");
          window.teacherMgr.renderExampleInputs();

          // Reset custom quiz form
          const customQuizCheckbox = $("custom-quiz-enabled");
          const customQuizSection = $("custom-quiz-form");
          customQuizCheckbox.checked = false;
          customQuizSection.classList.add("hidden");
          window.teacherMgr.quizQuestions = [];
          window.teacherMgr.renderQuizQuestions();

          $("modal-word").classList.remove("hidden");
        },

        editWord: (id) => {
          const w = window.db.words.find((i) => String(i.id) === String(id));
          if (!w) return alert("Kh√¥ng t√¨m th·∫•y t·ª´ n√†y.");

          $("word-mode").value = "edit";
          $("inp-id").value = w.id;
          $("inp-id").disabled = true;

          $("inp-kanji").value = w.kanji || "";
          $("inp-furigana").value = w.furigana || "";
          $("inp-romaji").value = w.romaji || "";
          $("inp-vi").value = w.vi || "";
          $("inp-image-base64").value = w.image || "";

          if (w.image) {
            $("preview-image").src = w.image;
            $("preview-image-container").classList.remove("hidden");
          } else {
            $("preview-image-container").classList.add("hidden");
          }
          window.teacherMgr.renderExampleInputs(w.examples || []);

          // Show modal first to ensure DOM elements are accessible
          $("modal-word").classList.remove("hidden");

          // Populate custom quiz if exists (after modal is shown)
          setTimeout(() => {
            const customQuizCheckbox = $("custom-quiz-enabled");
            const customQuizSection = $("custom-quiz-form");
            if (w.customQuiz?.enabled && w.customQuiz.questions) {
              customQuizCheckbox.checked = true;
              customQuizSection.classList.remove("hidden");
              window.teacherMgr.quizQuestions = w.customQuiz.questions.map(
                (q) => ({ ...q }),
              );
              window.teacherMgr.renderQuizQuestions();
            } else {
              customQuizCheckbox.checked = false;
              customQuizSection.classList.add("hidden");
              window.teacherMgr.quizQuestions = [];
              window.teacherMgr.renderQuizQuestions();
            }
          }, 0);
        },

        // Quiz questions management
        quizQuestions: [],

        addQuizQuestion: () => {
          if (window.teacherMgr.quizQuestions.length >= 5) {
            return showToast("T·ªëi ƒëa 5 c√¢u h·ªèi!");
          }
          window.teacherMgr.quizQuestions.push({
            question: "",
            options: [
              { text: "", isCorrect: false },
              { text: "", isCorrect: false },
              { text: "", isCorrect: false },
              { text: "", isCorrect: true },
            ],
          });
          window.teacherMgr.renderQuizQuestions();
        },

        removeQuizQuestion: (index) => {
          window.teacherMgr.quizQuestions.splice(index, 1);
          window.teacherMgr.renderQuizQuestions();
        },

        renderQuizQuestions: () => {
          const container = $("quiz-questions-container");
          if (!container) return;

          if (window.teacherMgr.quizQuestions.length === 0) {
            container.innerHTML = `
              <div class="text-center py-4 text-slate-400 text-sm">
                <i class="fas fa-plus-circle text-2xl mb-2"></i>
                <p>Ch∆∞a c√≥ c√¢u h·ªèi n√†o. Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ th√™m.</p>
              </div>
            `;
            return;
          }

          container.innerHTML = window.teacherMgr.quizQuestions
            .map(
              (q, qIdx) => `
            <div class="bg-slate-900/50 p-3 rounded-lg border border-purple-500/30 mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-purple-400 font-bold text-sm">C√¢u ${qIdx + 1}</span>
                <button 
                  type="button"
                  onclick="teacherMgr.removeQuizQuestion(${qIdx})"
                  class="text-red-400 hover:text-red-300 text-xs"
                >
                  <i class="fas fa-trash"></i> X√≥a
                </button>
              </div>
              
              <textarea
                id="quiz-q-${qIdx}"
                class="w-full bg-slate-700 text-white p-2 rounded border border-slate-600 text-sm mb-2"
                rows="2"
                placeholder="Nh·∫≠p c√¢u h·ªèi..."
                onchange="teacherMgr.quizQuestions[${qIdx}].question = this.value"
              >${q.question || ""}</textarea>
              
              <div class="space-y-1">
                ${q.options
                  .map(
                    (opt, optIdx) => `
                  <div class="flex items-center gap-2">
                    <input
                      type="radio"
                      name="correct-q${qIdx}"
                      ${opt.isCorrect ? "checked" : ""}
                      onchange="teacherMgr.quizQuestions[${qIdx}].options.forEach((o,i) => o.isCorrect = i === ${optIdx})"
                      class="w-4 h-4"
                    />
                    <span class="text-purple-400 text-xs font-bold w-6">${String.fromCharCode(65 + optIdx)}.</span>
                    <input
                      type="text"
                      value="${opt.text || ""}"
                      class="flex-1 bg-slate-700 text-white p-1.5 rounded border border-slate-600 text-xs"
                      placeholder="ƒê√°p √°n ${String.fromCharCode(65 + optIdx)}"
                      onchange="teacherMgr.quizQuestions[${qIdx}].options[${optIdx}].text = this.value"
                    />
                  </div>
                `,
                  )
                  .join("")}
              </div>
            </div>
          `,
            )
            .join("");
        },

        renderExampleInputs: (examples = []) => {
          const container = $("example-inputs-container");
          container.innerHTML = "";
          for (let i = 0; i < 2; i++) {
            const ex = examples[i] || {};
            const jpVal = (ex.jp || "").replace(/"/g, "&quot;");
            const viVal = (ex.vi || "").replace(/"/g, "&quot;");

            container.innerHTML += `
                    <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 space-y-2 mb-2">
                        <div class="grid grid-cols-2 gap-2">
                            <input id="inp-ex-jp-${i}" value="${jpVal}" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm font-jp focus:border-purple-500 outline-none" placeholder="C√¢u Nh·∫≠t (g√µ tay ho·∫∑c ƒë·ªÉ AI t·∫°o)">
                            <input id="inp-ex-vi-${i}" value="${viVal}" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm focus:border-purple-500 outline-none" placeholder="Nghƒ©a Vi·ªát">
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="btn-ai-ex-${i}" onclick="geminiService.enrichExample(${i})" 
                                class="text-[10px] bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded border border-slate-600 flex items-center gap-1 transition-colors">
                                <i class="fas fa-wand-magic-sparkles"></i> AI Furigana + D·ªãch
                            </button>
                        </div>
                    </div>`;
          }
        },

        saveWord: async () => {
          const id = $("inp-id").value.trim();
          if (!id) return alert("Thi·∫øu ID!");
          const nw = {
            id,
            lesson: Number(window.session.currentLesson),
            kanji: $("inp-kanji").value,
            furigana: $("inp-furigana").value,
            romaji: $("inp-romaji").value,
            vi: $("inp-vi").value,
            image: $("inp-image-base64").value,
            examples: [],
          };
          for (let i = 0; i < 2; i++) {
            const j = $(`inp-ex-jp-${i}`).value;
            const v = $(`inp-ex-vi-${i}`).value;
            if (j || v) nw.examples.push({ jp: j, vi: v });
          }

          // Save custom quiz if enabled
          const quizEnabled = $("custom-quiz-enabled").checked;
          if (quizEnabled) {
            const questions = window.teacherMgr.quizQuestions;

            // Validate: must have at least 1 question, max 5
            if (questions.length === 0) {
              return alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 c√¢u h·ªèi cho quiz!");
            }

            // Validate each question
            const allValid = questions.every((q, idx) => {
              if (!q.question.trim()) {
                alert(`C√¢u ${idx + 1}: Vui l√≤ng nh·∫≠p c√¢u h·ªèi!`);
                return false;
              }
              const allOptionsFilled = q.options.every((opt) =>
                opt.text.trim(),
              );
              if (!allOptionsFilled) {
                alert(`C√¢u ${idx + 1}: Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß 4 ƒë√°p √°n!`);
                return false;
              }
              const hasCorrect = q.options.some((opt) => opt.isCorrect);
              if (!hasCorrect) {
                alert(`C√¢u ${idx + 1}: Vui l√≤ng ch·ªçn ƒë√°p √°n ƒë√∫ng!`);
                return false;
              }
              return true;
            });

            if (!allValid) return;

            nw.customQuiz = {
              enabled: true,
              questions: questions,
            };
          }

          showToast("ƒêang l∆∞u...");
          const success = await window.cloud.saveWord(nw);
          if (success) {
            showToast("ƒê√£ l∆∞u!");
            window.teacherMgr.closeModal();
          }
        },

        closeModal: () => $("modal-word").classList.add("hidden"),

        deleteWord: async (id) => {
          if (confirm("X√≥a t·ª´ n√†y vƒ©nh vi·ªÖn?"))
            await window.cloud.deleteWord(id);
        },

        deleteAllWords: async () => {
          const lesson = window.session.currentLesson;
          const words = window.teacherMgr.currentWords;
          if (!words || words.length === 0)
            return alert("B√†i n√†y ch∆∞a c√≥ t·ª´ n√†o ƒë·ªÉ x√≥a!");

          const userConfirm = prompt(
            `C·∫¢NH B√ÅO NGUY HI·ªÇM:\nB·∫°n s·∫Øp x√≥a TO√ÄN B·ªò ${words.length} t·ª´ c·ªßa B√†i ${lesson}.\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.\n\nVui l√≤ng nh·∫≠p ch·ªØ "DELETE" (vi·∫øt hoa) ƒë·ªÉ x√°c nh·∫≠n:`,
          );

          if (userConfirm !== "DELETE") {
            return alert("H·ªßy x√≥a. M√£ x√°c nh·∫≠n kh√¥ng ƒë√∫ng.");
          }

          if (!confirm("H·ªèi l·∫°i l·∫ßn cu·ªëi: Ch·∫Øc ch·∫Øn x√≥a s·∫°ch ch·ª©?")) return;

          showToast(`ƒêang x√≥a ${words.length} t·ª´...`);
          try {
            await Promise.all(words.map((w) => window.cloud.deleteWord(w.id)));
            showToast("ƒê√£ x√≥a s·∫°ch s·∫Ω!");
          } catch (e) {
            alert("C√≥ l·ªói x·∫£y ra khi x√≥a: " + e.message);
          }
        },
      };

      window.questionList = {
        currentFilter: "all",
        allWords: [],
        filteredWords: [],
        currentWordIndex: 0,

        init: (words, currentIndex = 0) => {
          window.questionList.allWords = words;
          window.questionList.currentWordIndex = currentIndex;
          window.questionList.updateCounts();
          window.questionList.filterByStatus("all");
        },

        updateCounts: () => {
          const progress = window.db.progress[window.session.user.email] || {};
          const counts = { all: 0, learning: 0, review: 0, mastered: 0 };

          window.questionList.allWords.forEach((word) => {
            counts.all++;
            const status = progress[word.id] || "learning";
            counts[status] = (counts[status] || 0) + 1;
          });

          $("count-all").innerText = counts.all;
          $("count-learning").innerText = counts.learning;
          $("count-review").innerText = counts.review;
          $("count-mastered").innerText = counts.mastered;
        },

        filterByStatus: (status) => {
          window.questionList.currentFilter = status;

          // Update button styles
          ["all", "learning", "review", "mastered"].forEach((s) => {
            const btn = $("filter-" + s);
            if (s === status) {
              btn.className =
                "px-4 py-2 rounded-full bg-purple-600 text-white font-bold text-sm whitespace-nowrap";
            } else {
              btn.className =
                "px-4 py-2 rounded-full bg-slate-800 text-slate-400 font-bold text-sm whitespace-nowrap border border-slate-700";
            }
          });

          // Filter words
          const progress = window.db.progress[window.session.user.email] || {};
          if (status === "all") {
            window.questionList.filteredWords = window.questionList.allWords;
          } else {
            window.questionList.filteredWords =
              window.questionList.allWords.filter((w) => {
                const wordStatus = progress[w.id] || "learning";
                return wordStatus === status;
              });
          }

          window.questionList.render();
        },

        search: (query) => {
          const searchTerm = query.toLowerCase().trim();
          if (!searchTerm) {
            window.questionList.filterByStatus(
              window.questionList.currentFilter,
            );
            return;
          }

          window.questionList.filteredWords =
            window.questionList.allWords.filter((w) => {
              return (
                w.kanji.toLowerCase().includes(searchTerm) ||
                (w.furigana && w.furigana.toLowerCase().includes(searchTerm)) ||
                (w.romaji && w.romaji.toLowerCase().includes(searchTerm)) ||
                w.vi.toLowerCase().includes(searchTerm)
              );
            });

          window.questionList.render();
        },

        render: () => {
          const container = $("question-list-container");
          const progress = window.db.progress[window.session.user.email] || {};

          if (window.questionList.filteredWords.length === 0) {
            container.innerHTML = `
              <div class="text-center py-12 text-slate-400">
                <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                <p>Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng n√†o</p>
              </div>
            `;
            return;
          }

          container.innerHTML = window.questionList.filteredWords
            .map((word, idx) => {
              const status = progress[word.id] || "learning";
              const statusColors = {
                learning: "border-blue-500/30 bg-blue-500/5",
                review: "border-orange-500/30 bg-orange-500/5",
                mastered: "border-green-500/30 bg-green-500/5",
              };
              const statusIcons = {
                learning: '<i class="fas fa-book-open text-blue-400"></i>',
                review: '<i class="fas fa-sync-alt text-orange-400"></i>',
                mastered: '<i class="fas fa-check-circle text-green-400"></i>',
              };
              const statusLabels = {
                learning: "ƒêang h·ªçc",
                review: "√în l·∫°i",
                mastered: "ƒê√£ thu·ªôc",
              };

              const actualIndex = window.questionList.allWords.findIndex(
                (w) => w.id === word.id,
              );

              return `
              <div 
                onclick="questionList.jumpToWord(${actualIndex})"
                class="glass p-4 rounded-xl border ${statusColors[status]} cursor-pointer hover:border-purple-500/50 transition-all active:scale-98"
              >
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-xs text-slate-500 font-mono">#${actualIndex + 1}</span>
                      ${statusIcons[status]}
                      <span class="text-xs text-slate-400">${statusLabels[status]}</span>
                    </div>
                    <div class="text-lg font-bold text-white mb-1">${word.kanji}</div>
                    <div class="text-sm text-slate-400 mb-1">${word.furigana || ""}</div>
                    <div class="text-sm text-slate-300">${word.vi}</div>
                  </div>
                  <i class="fas fa-chevron-right text-slate-600 mt-2"></i>
                </div>
              </div>
            `;
            })
            .join("");
        },

        jumpToWord: (index) => {
          // Jump to specific word in study mode
          window.session.currentIndex = index;
          window.session.studyList = window.questionList.allWords;
          window.studentStudy.render();
          showScreen("screen-student-study");
        },
      };

      window.studentStudy = {
        init: (w, tid, startIndex) => {
          window.session.studyList = [...w];
          if (tid) {
            // NFC mode - find word by ID
            window.session.currentIndex = Math.max(
              0,
              window.session.studyList.findIndex((x) => x.id === tid),
            );
          } else if (startIndex !== undefined) {
            // Resume from saved index
            window.session.currentIndex = Math.min(
              startIndex,
              window.session.studyList.length - 1,
            );
          } else {
            // Start from beginning
            window.session.currentIndex = 0;
          }
          window.studentStudy.render();
        },
        render: () => {
          const w = window.session.studyList[window.session.currentIndex];
          if (!w) return;

          // Save current position to localStorage
          localStorage.setItem(
            "jpd123_lastStudiedIndex",
            window.session.currentIndex.toString(),
          );

          // Hide navigation buttons if in NFC mode, but keep quiz button
          if (window.session.isNFCMode) {
            $("study-nav-buttons").style.display = "none";
            // Show NFC buttons
            if ($("quiz-button-nfc")) {
              $("quiz-button-nfc").classList.remove("hidden");
              // Show back to list button only for logged-in users (not guests)
              const backBtn = $("nfc-back-to-list");
              if (backBtn) {
                if (window.session.user.email !== "guest@nfc.temp") {
                  backBtn.classList.remove("hidden");
                } else {
                  backBtn.classList.add("hidden");
                }
              }
            }
          } else {
            $("study-nav-buttons").style.display = "grid";
            if ($("quiz-button-nfc")) {
              $("quiz-button-nfc").classList.add("hidden");
            }
          }

          $("fc-current-index").innerText = window.session.currentIndex + 1;
          $("fc-total").innerText = window.session.studyList.length;
          $("fc-progress-bar").style.width = `${
            ((window.session.currentIndex + 1) /
              window.session.studyList.length) *
            100
          }%`;
          $("flashcard-inner").parentElement.classList.remove("card-flip");
          $("fc-furigana-front").innerText = w.furigana || "";
          $("fc-kanji-front").innerText = w.kanji;
          $("fc-kanji-back").innerHTML = generateRubyHtml(w.kanji, w.furigana);
          $("fc-meaning-vi").innerText = w.vi;
          $("fc-romaji").innerText = w.romaji || "";
          if (w.image) {
            $("fc-image-back").src = w.image;
            $("fc-image-container-back").classList.remove("hidden");
          } else $("fc-image-container-back").classList.add("hidden");
          $("fc-examples").innerHTML = (w.examples || [])
            .map(
              (e) =>
                `<div class="bg-black/20 p-2 rounded-lg border border-white/5"><div class="flex justify-between mb-1"><span class="text-blue-300 font-jp">${
                  e.jp
                }</span><i onclick="event.stopPropagation(); speakJP('${e.jp.replace(
                  /'/g,
                  "\\'",
                )}')" class="fas fa-volume-up text-slate-500 cursor-pointer"></i></div><div class="text-xs text-slate-300">${
                  e.vi
                }</div></div>`,
            )
            .join("");
        },
        navigateToQuestionList: () => {
          // Only for logged-in users
          if (window.session.user.email === "guest@nfc.temp") {
            showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch c√¢u h·ªèi");
            return;
          }
          // Load all words and show question list screen
          window.questionList.init(
            window.db.words,
            window.session.currentIndex,
          );
          showScreen("screen-question-list");
        },
        startReviewFromCurrent: () => {
          // Start reviewing from current position (works for all users including guests)
          const currentIdx = window.session.currentIndex;
          const wordsFromCurrent = window.session.studyList.slice(currentIdx);

          if (wordsFromCurrent.length === 0) {
            showToast("Kh√¥ng c√≤n t·ª´ n√†o ƒë·ªÉ √¥n");
            return;
          }

          showToast(
            `B·∫Øt ƒë·∫ßu √¥n ${wordsFromCurrent.length} t·ª´ t·ª´ v·ªã tr√≠ hi·ªán t·∫°i`,
          );
          // Reinitialize with words from current position
          window.session.studyList = wordsFromCurrent;
          window.session.currentIndex = 0;
          window.studentStudy.render();
        },
        flipCard: () => {
          const c = $("flashcard-inner").parentElement;
          c.classList.toggle("card-flip");
          if (c.classList.contains("card-flip")) {
            const w = window.session.studyList[window.session.currentIndex];
            speakJP(w.kanji);
          }
        },
        prevCard: () => {
          if (window.session.currentIndex > 0) {
            window.session.currentIndex--;
            window.studentStudy.render();
          }
        },
        nextCard: () => {
          if (
            window.session.currentIndex <
            window.session.studyList.length - 1
          ) {
            window.session.currentIndex++;
            window.studentStudy.render();
          } else showToast("ƒê√£ h·∫øt th·∫ª!");
        },
        markStatus: (s) => {
          const w = window.session.studyList[window.session.currentIndex];
          const email = window.session.user.email;

          // Skip saving progress for guest users
          if (email === "guest@nfc.temp") {
            showToast("Ch·∫ø ƒë·ªô xem - kh√¥ng l∆∞u ti·∫øn ƒë·ªô");
            setTimeout(() => {
              if (
                window.session.currentIndex <
                window.session.studyList.length - 1
              ) {
                window.session.currentIndex++;
                window.studentStudy.render();
              }
            }, 300);
            return;
          }

          if (!window.db.progress[email]) window.db.progress[email] = {};
          window.db.progress[email][w.id] = {
            status: s,
            lastReviewed: Date.now(),
          };
          window.progressCloud.saveStudentProgress({
            email: window.session.user.email,
            name: window.session.user.name,
            className: window.session.user.className || "",
            progress: window.db.progress[email],
          });
          showToast("ƒê√£ l∆∞u ti·∫øn ƒë·ªô!");
          setTimeout(() => {
            if (
              window.session.currentIndex <
              window.session.studyList.length - 1
            ) {
              window.session.currentIndex++;
              window.studentStudy.render();
            }
          }, 300);
        },
        toggleShuffle: () => {
          window.session.isShuffle = !window.session.isShuffle;
          $("btn-shuffle").classList.toggle(
            "text-purple-400",
            window.session.isShuffle,
          );
          if (window.session.isShuffle)
            window.session.studyList.sort(() => Math.random() - 0.5);
          else
            window.session.studyList = window.db.words.filter(
              (w) => w.lesson === window.session.currentLesson,
            );
          window.session.currentIndex = 0;
          window.studentStudy.render();
        },
        playAudio: () => {
          const w = window.session.studyList[window.session.currentIndex];
          speakJP(w.kanji);
        },
        toggleFav: () => {
          const i = $("fc-star");
          i.classList.toggle("fas");
          i.classList.toggle("far");
        },

        startQuiz: () => {
          const currentWord =
            window.session.studyList[window.session.currentIndex];

          // Check if word has custom quiz enabled with multiple questions
          if (
            currentWord.customQuiz?.enabled &&
            currentWord.customQuiz.questions
          ) {
            const questions = currentWord.customQuiz.questions;

            // Validate custom quiz data
            const allValid = questions.every(
              (q) =>
                q.options?.length === 4 &&
                q.options.every((opt) => opt.text?.trim()) &&
                q.options.some((opt) => opt.isCorrect),
            );

            if (allValid && questions.length > 0) {
              // Initialize multi-question quiz
              window.session.isCustomQuiz = true;
              window.session.quizQuestions = questions;
              window.session.currentQuizIndex = 0;
              window.session.quizScore = 0;
              window.session.quizAnswers = [];

              // Render first question
              studentStudy.renderQuizQuestion();

              // Transition to quiz screen
              $("screen-student-study").classList.add("fade-out");
              setTimeout(() => {
                $("screen-student-study").classList.add("hidden");
                $("screen-student-study").classList.remove("fade-out");
                $("screen-quiz").classList.remove("hidden");
                $("screen-quiz").classList.add("fade-in");
                setTimeout(() => {
                  $("screen-quiz").classList.remove("fade-in");
                }, 300);
              }, 300);
              return;
            } else {
              showToast("‚ö†Ô∏è Quiz t√πy ch·ªânh kh√¥ng h·ª£p l·ªá, d√πng c√¢u h·ªèi t·ª± ƒë·ªông");
            }
          }

          // Auto-generate quiz (original logic)
          window.session.isCustomQuiz = false;

          // In NFC mode, use all words from database for quiz options
          // In normal mode, use current study list
          const allWords = window.session.isNFCMode
            ? window.db.words
            : window.session.studyList;

          // Check if enough words for quiz
          if (allWords.length < 4) {
            showToast("C·∫ßn √≠t nh·∫•t 4 t·ª´ v·ª±ng ƒë·ªÉ l√†m quiz!");
            return;
          }

          // Generate wrong answers (3 random different words)
          const wrongWords = allWords
            .filter((w) => w.id !== currentWord.id)
            .sort(() => Math.random() - 0.5)
            .slice(0, 3);

          // Create 4 options and shuffle
          const options = [currentWord, ...wrongWords].sort(
            () => Math.random() - 0.5,
          );

          // Save quiz state
          window.session.quizCorrectIndex = options.findIndex(
            (w) => w.id === currentWord.id,
          );
          window.session.quizOptions = options;

          // Render quiz
          $("quiz-furigana").innerText = currentWord.furigana || "";
          $("quiz-question").innerText = currentWord.kanji;

          options.forEach((word, index) => {
            $(`quiz-text-${index}`).innerText = word.vi;
            const btn = $(`quiz-option-${index}`);
            btn.disabled = false;
            btn.className =
              "quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center";
          });

          $("quiz-continue-btn").classList.add("hidden");

          // Transition from flashcard to quiz with fade
          $("screen-student-study").classList.add("fade-out");
          setTimeout(() => {
            $("screen-student-study").classList.add("hidden");
            $("screen-student-study").classList.remove("fade-out");
            $("screen-quiz").classList.remove("hidden");
            $("screen-quiz").classList.add("fade-in");
            setTimeout(() => {
              $("screen-quiz").classList.remove("fade-in");
            }, 300);
          }, 300);
        },

        renderQuizQuestion: () => {
          const q =
            window.session.quizQuestions[window.session.currentQuizIndex];
          const currentWord =
            window.session.studyList[window.session.currentIndex];

          // Shuffle options
          const shuffledOptions = [...q.options].sort(
            () => Math.random() - 0.5,
          );
          window.session.quizCorrectIndex = shuffledOptions.findIndex(
            (opt) => opt.isCorrect,
          );
          window.session.quizOptions = shuffledOptions;

          // Update progress indicator
          const progress = `C√¢u ${window.session.currentQuizIndex + 1}/${window.session.quizQuestions.length}`;
          $("quiz-progress").innerText = progress;

          // Render question
          $("quiz-furigana").innerText = currentWord.furigana || "";
          $("quiz-question").innerText = q.question;

          // Render options
          shuffledOptions.forEach((option, index) => {
            $(`quiz-text-${index}`).innerText = option.text;
            const btn = $(`quiz-option-${index}`);
            btn.disabled = false;
            btn.className =
              "quiz-option bg-slate-800 hover:bg-slate-700 text-white p-6 rounded-xl border-2 border-slate-600 transition-all duration-300 text-left min-h-[100px] flex items-center";
          });

          $("quiz-continue-btn").classList.add("hidden");
        },

        checkAnswer: (selectedIndex) => {
          const correctIndex = window.session.quizCorrectIndex;
          const isCorrect = selectedIndex === correctIndex;

          // Disable all buttons
          for (let i = 0; i < 4; i++) {
            $(`quiz-option-${i}`).disabled = true;
          }

          if (isCorrect) {
            // Correct answer - green + confetti
            $(`quiz-option-${selectedIndex}`).className =
              "quiz-option bg-green-500 border-green-400 text-white p-6 rounded-xl border-2 transition-all duration-300 text-left min-h-[100px] flex items-center";

            // Confetti effect for multi-question quiz only on last question
            if (window.session.isCustomQuiz) {
              window.session.quizScore++;
            } else {
              confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
              });
            }

            // Update progress to mastered for single auto-generated quiz
            if (!window.session.isCustomQuiz) {
              const currentWord =
                window.session.studyList[window.session.currentIndex];
              const email = window.session.user.email;

              // Only save progress for non-guest users
              if (email !== "guest@nfc.temp") {
                if (!window.db.progress[email]) window.db.progress[email] = {};
                window.db.progress[email][currentWord.id] = {
                  status: "mastered",
                  lastReviewed: Date.now(),
                };
                window.progressCloud.saveStudentProgress({
                  email: window.session.user.email,
                  name: window.session.user.name,
                  className: window.session.user.className || "",
                  progress: window.db.progress[email],
                });
              }
            }

            showToast("Ch√≠nh x√°c! üéâ");
          } else {
            // Wrong answer - red + shake + show correct
            const selectedBtn = $(`quiz-option-${selectedIndex}`);
            selectedBtn.className =
              "quiz-option bg-red-500 border-red-400 text-white p-6 rounded-xl border-2 transition-all duration-300 text-left min-h-[100px] flex items-center shake";

            // Show correct answer in green
            setTimeout(() => {
              $(`quiz-option-${correctIndex}`).className =
                "quiz-option bg-green-500 border-green-400 text-white p-6 rounded-xl border-2 transition-all duration-300 text-left min-h-[100px] flex items-center";
            }, 500);

            showToast("Sai r·ªìi!");
          }

          // Store answer for multi-question quiz
          if (window.session.isCustomQuiz) {
            window.session.quizAnswers.push({
              questionIndex: window.session.currentQuizIndex,
              isCorrect: isCorrect,
            });
          }

          // Auto-advance to next question or show results
          setTimeout(() => {
            if (
              window.session.isCustomQuiz &&
              window.session.currentQuizIndex <
                window.session.quizQuestions.length - 1
            ) {
              // More questions - load next
              window.session.currentQuizIndex++;
              studentStudy.renderQuizQuestion();
            } else if (window.session.isCustomQuiz) {
              // Last question - show final results
              studentStudy.showQuizResults();
            } else {
              // Single question quiz - show continue button
              $("quiz-continue-btn").classList.remove("hidden");
            }
          }, 1500);
        },

        showQuizResults: () => {
          const total = window.session.quizQuestions.length;
          const score = window.session.quizScore;
          const percentage = Math.round((score / total) * 100);

          // Big confetti if score >= 80%
          if (percentage >= 80) {
            confetti({
              particleCount: 150,
              spread: 100,
              origin: { y: 0.6 },
            });
          }

          // Update progress to mastered if score is good
          if (percentage >= 60) {
            const currentWord =
              window.session.studyList[window.session.currentIndex];
            const email = window.session.user.email;
            if (email !== "guest@nfc.temp") {
              if (!window.db.progress[email]) window.db.progress[email] = {};
              window.db.progress[email][currentWord.id] = {
                status: "mastered",
                lastReviewed: Date.now(),
              };
              window.progressCloud.saveStudentProgress({
                email: window.session.user.email,
                name: window.session.user.name,
                className: window.session.user.className || "",
                progress: window.db.progress[email],
              });
            }
          }

          // Show results screen
          const resultColor =
            percentage >= 80
              ? "text-green-400"
              : percentage >= 60
                ? "text-yellow-400"
                : "text-red-400";
          const resultEmoji =
            percentage >= 80 ? "üéâ" : percentage >= 60 ? "üëç" : "üìö";

          $("quiz-furigana").innerText = "";
          $("quiz-question").innerHTML = `
            <div class="text-center">
              <div class="${resultColor} text-6xl mb-4">${resultEmoji}</div>
              <div class="text-3xl mb-2">K·∫øt qu·∫£</div>
              <div class="${resultColor} text-5xl font-bold mb-4">${score}/${total}</div>
              <div class="text-2xl text-slate-300">${percentage}% ƒë√∫ng</div>
            </div>
          `;

          // Hide options, show continue
          for (let i = 0; i < 4; i++) {
            $(`quiz-option-${i}`).style.display = "none";
          }
          $("quiz-continue-btn").classList.remove("hidden");
        },

        exitQuiz: () => {
          // Reset quiz options visibility
          for (let i = 0; i < 4; i++) {
            $(`quiz-option-${i}`).style.display = "flex";
          }

          // Reset progress indicator
          $("quiz-progress").innerText = "";

          // Transition from quiz back to flashcard
          $("screen-quiz").classList.add("fade-out");
          setTimeout(() => {
            $("screen-quiz").classList.add("hidden");
            $("screen-quiz").classList.remove("fade-out");

            // Handle NFC mode vs normal mode
            if (window.session.isNFCMode) {
              // In NFC mode, just show the flashcard again (same word)
              $("screen-student-study").classList.remove("hidden");
              $("screen-student-study").classList.add("fade-in");
              setTimeout(() => {
                $("screen-student-study").classList.remove("fade-in");
              }, 300);
            } else {
              // In normal mode, move to next card only for auto-generated quiz
              if (
                !window.session.isCustomQuiz &&
                window.session.currentIndex <
                  window.session.studyList.length - 1
              ) {
                window.session.currentIndex++;
                window.studentStudy.render();
              } else if (!window.session.isCustomQuiz) {
                showToast("ƒê√£ h·∫øt t·ª´ v·ª±ng!");
              }
              $("screen-student-study").classList.remove("hidden");
              $("screen-student-study").classList.add("fade-in");
              setTimeout(() => {
                $("screen-student-study").classList.remove("fade-in");
              }, 300);
            }
          }, 300);
        },
      };

      window.handleVocabUpdate = () => {
        if (window.session.user?.role === "teacher") {
          const scrMgr = $("screen-teacher-manager");
          if (scrMgr && !scrMgr.classList.contains("hidden")) {
            const currentLesson = window.session.currentLesson;
            window.teacherMgr.currentWords = currentLesson
              ? window.db.words.filter((w) => w.lesson === currentLesson)
              : window.db.words;
            window.teacherMgr.renderList();
          }
        }
        if (window.session.user?.role === "student") {
          const scrStudy = $("screen-student-study");
          if (scrStudy && !scrStudy.classList.contains("hidden")) {
            const lesson = window.session.currentLesson;
            if (!lesson) return;
            const wordsForLesson = window.db.words.filter(
              (w) => w.lesson === lesson,
            );
            const currentId =
              window.session.studyList[window.session.currentIndex]?.id;
            window.session.studyList = [...wordsForLesson];
            let newIndex = 0;
            if (currentId) {
              const idx = wordsForLesson.findIndex((w) => w.id === currentId);
              if (idx !== -1) newIndex = idx;
            }
            window.session.currentIndex = newIndex;
            window.studentStudy.render();
          }
        }
      };

      // --- CLASS MANAGEMENT ---
      window.classMgr = {
        currentTab: "students",

        init: () => {
          window.classMgr.calculateStats();
          window.classMgr.renderStudentView();
        },

        calculateStats: () => {
          const students = window.__progressDocs || [];
          const totalWords = window.db.words.length;

          $("total-students").innerText = students.length;
          $("total-words-count").innerText = totalWords;

          if (students.length > 0 && totalWords > 0) {
            const totalMastered = students.reduce((sum, s) => {
              const mastered = Object.values(s.progress || {}).filter(
                (p) => p.status === "mastered",
              ).length;
              return sum + mastered;
            }, 0);
            const avgMastery = (
              (totalMastered / (students.length * totalWords)) *
              100
            ).toFixed(1);
            $("avg-mastery").innerText = avgMastery + "%";
          } else {
            $("avg-mastery").innerText = "0%";
          }
        },

        switchTab: (tab) => {
          window.classMgr.currentTab = tab;

          // Update tab styles
          $("tab-students").className =
            tab === "students"
              ? "px-4 py-2 font-bold border-b-2 border-purple-500 text-purple-400"
              : "px-4 py-2 font-bold border-b-2 border-transparent text-slate-400 hover:text-white";
          $("tab-words").className =
            tab === "words"
              ? "px-4 py-2 font-bold border-b-2 border-purple-500 text-purple-400"
              : "px-4 py-2 font-bold border-b-2 border-transparent text-slate-400 hover:text-white";

          // Show/hide views
          if (tab === "students") {
            $("view-students").classList.remove("hidden");
            $("view-words").classList.add("hidden");
            window.classMgr.renderStudentView();
          } else {
            $("view-students").classList.add("hidden");
            $("view-words").classList.remove("hidden");
            window.classMgr.renderWordView();
          }
        },

        renderStudentView: () => {
          const students = window.__progressDocs || [];
          const totalWords = window.db.words.length;

          if (students.length === 0) {
            $("view-students").innerHTML = `
              <div class="text-center py-8 text-slate-400">
                <i class="fas fa-users text-6xl mb-4 opacity-50"></i>
                <p>Ch∆∞a c√≥ h·ªçc sinh n√†o</p>
              </div>
            `;
            return;
          }

          $("view-students").innerHTML = students
            .map((s) => {
              const progress = s.progress || {};
              const mastered = Object.values(progress).filter(
                (p) => p.status === "mastered",
              ).length;
              const review = Object.values(progress).filter(
                (p) => p.status === "review",
              ).length;
              const learning = Object.values(progress).filter(
                (p) => p.status === "learning",
              ).length;
              const studied = Object.keys(progress).length;
              const masteredPercent =
                totalWords > 0 ? ((mastered / totalWords) * 100).toFixed(1) : 0;

              return `
              <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="font-bold text-white">${s.name || "Unknown"}</h3>
                    <p class="text-xs text-slate-400">${s.email || ""}</p>
                    <p class="text-xs text-slate-500">${s.className || "N/A"}</p>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-green-400">${masteredPercent}%</div>
                    <div class="text-xs text-slate-400">ƒê√£ thu·ªôc</div>
                  </div>
                </div>
                
                <div class="w-full bg-slate-700 rounded-full h-2 mb-3">
                  <div class="bg-gradient-to-r from-green-400 to-emerald-500 h-2 rounded-full" style="width: ${masteredPercent}%"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-center text-xs">
                  <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-orange-400 font-bold">${review}</div>
                    <div class="text-slate-500">C·∫ßn √¥n</div>
                  </div>
                  <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-green-400 font-bold">${mastered}</div>
                    <div class="text-slate-500">Thu·ªôc</div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        },

        renderWordView: () => {
          const students = window.__progressDocs || [];
          const words = window.db.words;

          if (words.length === 0) {
            $("view-words").innerHTML = `
              <div class="text-center py-8 text-slate-400">
                <i class="fas fa-book text-6xl mb-4 opacity-50"></i>
                <p>Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o</p>
              </div>
            `;
            return;
          }

          const wordStats = words.map((w) => {
            let masteredCount = 0;
            let reviewCount = 0;
            let learningCount = 0;

            students.forEach((s) => {
              const progress = s.progress || {};
              if (progress[w.id]) {
                if (progress[w.id].status === "mastered") masteredCount++;
                else if (progress[w.id].status === "review") reviewCount++;
                else if (progress[w.id].status === "learning") learningCount++;
              }
            });

            const totalStudents = students.length;
            const masteredPercent =
              totalStudents > 0
                ? ((masteredCount / totalStudents) * 100).toFixed(1)
                : 0;

            return {
              word: w,
              masteredCount,
              reviewCount,
              learningCount,
              masteredPercent,
              totalStudents,
            };
          });

          // Sort by mastered percentage (descending)
          wordStats.sort(
            (a, b) =>
              parseFloat(b.masteredPercent) - parseFloat(a.masteredPercent),
          );

          $("view-words").innerHTML = wordStats
            .map((ws) => {
              const w = ws.word;
              return `
              <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 cursor-pointer hover:border-purple-500 transition-colors" onclick="window.classMgr.showWordDetail('${w.id}')">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <p class="text-sm text-slate-400">${w.furigana}</p>
                    <h3 class="font-bold text-white font-jp text-xl">${w.kanji}</h3>
                    <p class="text-xs text-purple-300">${w.vi}</p>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold ${ws.masteredPercent >= 70 ? "text-green-400" : ws.masteredPercent >= 40 ? "text-orange-400" : "text-red-400"}">${ws.masteredPercent}%</div>
                    <div class="text-xs text-slate-400">ƒê√£ thu·ªôc</div>
                  </div>
                </div>
                
                <div class="w-full bg-slate-700 rounded-full h-2 mb-3">
                  <div class="bg-gradient-to-r from-green-400 to-emerald-500 h-2 rounded-full" style="width: ${ws.masteredPercent}%"></div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                  <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-blue-400 font-bold">${ws.learningCount}</div>
                    <div class="text-slate-500">ƒêang h·ªçc</div>
                  </div>
                  <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-orange-400 font-bold">${ws.reviewCount}</div>
                    <div class="text-slate-500">C·∫ßn √¥n</div>
                  </div>
                  <div class="bg-slate-900/50 p-2 rounded">
                    <div class="text-green-400 font-bold">${ws.masteredCount}/${ws.totalStudents}</div>
                    <div class="text-slate-500">Thu·ªôc</div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        },

        showWordDetail: (wordId) => {
          const word = window.db.words.find((w) => w.id === wordId);
          if (!word) return;

          const students = window.__progressDocs || [];

          // Ph√¢n lo·∫°i h·ªçc sinh
          const studiedStudents = [];
          const notStudiedStudents = [];

          students.forEach((s) => {
            const progress = s.progress || {};
            if (progress[wordId]) {
              studiedStudents.push({
                student: s,
                status: progress[wordId].status,
              });
            } else {
              notStudiedStudents.push(s);
            }
          });

          // C·∫≠p nh·∫≠t th√¥ng tin t·ª´
          $("word-detail-kanji").innerText = word.kanji;
          $("word-detail-furigana").innerText = word.furigana || "";
          $("word-detail-vi").innerText = word.vi;

          // Render danh s√°ch h·ªçc sinh
          let html = "";

          if (studiedStudents.length > 0) {
            html += `
              <div class="mb-6">
                <h4 class="font-bold text-green-400 mb-3 flex items-center">
                  <i class="fas fa-check-circle mr-2"></i>
                  ƒê√£ h·ªçc (${studiedStudents.length} h·ªçc sinh)
                </h4>
                <div class="space-y-2">
            `;

            studiedStudents.forEach((item) => {
              const statusColor =
                item.status === "mastered"
                  ? "text-green-400"
                  : item.status === "review"
                    ? "text-orange-400"
                    : "text-blue-400";
              const statusText =
                item.status === "mastered"
                  ? "Thu·ªôc"
                  : item.status === "review"
                    ? "C·∫ßn √¥n"
                    : "ƒêang h·ªçc";

              html += `
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-center">
                  <div>
                    <div class="font-bold text-white">${item.student.name}</div>
                    <div class="text-xs text-slate-400">${item.student.studentId || "N/A"}</div>
                  </div>
                  <div class="${statusColor} text-sm font-bold">
                    ${statusText}
                  </div>
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;
          }

          if (notStudiedStudents.length > 0) {
            html += `
              <div>
                <h4 class="font-bold text-slate-400 mb-3 flex items-center">
                  <i class="fas fa-times-circle mr-2"></i>
                  Ch∆∞a h·ªçc (${notStudiedStudents.length} h·ªçc sinh)
                </h4>
                <div class="space-y-2">
            `;

            notStudiedStudents.forEach((s) => {
              html += `
                <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 flex justify-between items-center opacity-60">
                  <div>
                    <div class="font-bold text-white">${s.name}</div>
                    <div class="text-xs text-slate-400">${s.studentId || "N/A"}</div>
                  </div>
                  <div class="text-slate-500 text-sm">
                    Ch∆∞a h·ªçc
                  </div>
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;
          }

          if (students.length === 0) {
            html = `
              <div class="text-center py-8 text-slate-400">
                <i class="fas fa-users text-6xl mb-4 opacity-50"></i>
                <p>Ch∆∞a c√≥ h·ªçc sinh n√†o</p>
              </div>
            `;
          }

          $("word-detail-content").innerHTML = html;
          $("modal-word-detail").classList.remove("hidden");
        },

        closeWordDetail: () => {
          $("modal-word-detail").classList.add("hidden");
        },
      };

      window.onload = window.app.init;
    </script>
  </body>
</html>
